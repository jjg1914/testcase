# Copyright (C) 2012 John J. Glynn
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

vpath %.s $(SRCDIR)
vpath %.c $(SRCDIR)
vpath %.cpp $(SRCDIR)
vpath %.l $(SRCDIR)
vpath %.y $(SRCDIR)
vpath %.h $(INCLUDEDIR)
vpath %.hpp $(INCLUDEDIR)

ifneq ($(PACKAGES),)
CFLAGS += $(shell pkg-config --cflags $(PACKAGES))
LDLIBS += $(shell pkg-config --libs $(PACKAGES))
endif

CPPFLAGS += -D EXEC_$(EXECUTABLE) -I.

all : $(EXECUTABLE)

as : $(ASOUTPUT)

c : $(COUTPUT)

cxx : $(CXXOUTPUT)

lex : $(LOUTPUT)

yacc : $(YOUTPUT)

$(EXECUTABLE): $(ASOUTPUT) $(COUTPUT) $(CXXOUTPUT)
	$(LD) $(LDFLAGS) -o $@ $^ $(LDLIBS) $(LOADLIBES)

clean :
	rm -f y.tab.h $(YOUTPUT) $(LOUTPUT) $(COUTPUT) $(CXXOUTPUT) $(ASOUTPUT)\
		$(subst .o,.d,$(COUTPUT)) $(subst .o,.d,$(CXXOUTPUT))

# Include autogenerated dependencies
include $(subst .c,.d,$(CSOURCE))
include $(subst .cpp,.d,$(CXXSOURCE))

# Generate dependencies
%.d : %.c
	mkdir -p $(dir $@)
	$(CC) -MM $(CPPFLAGS) $< > $@.$$$$;\
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@;\
	rm -f $@.$$$$

%.d : %.cpp
	mkdir -p $(dir $@)
	$(CC) -MM $(CPPFLAGS) $< > $@.$$$$;\
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@;\
	rm -f $@.$$$$
